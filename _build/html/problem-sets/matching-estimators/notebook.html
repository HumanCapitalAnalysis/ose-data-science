

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Regression and matching estimators in causal effects &mdash; OSE data science  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Generalized Roy Model" href="../generalized-roy-model/notebook.html" />
    <link rel="prev" title="Potential outcome model" href="../potential-outcome-model/notebook.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> OSE data science
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../lectures/index.html">Lectures</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Problem sets</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#potential-outcome-model">Potential outcome model</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#matching-estimators">Matching estimators</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Regression and matching estimators in causal effects</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Task-A">Task A</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Task-B.-Regression-Adjustment">Task B. Regression Adjustment</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Task-C.-Matching-on-Propensity-Score">Task C. Matching on Propensity Score</a></li>
<li class="toctree-l4"><a class="reference internal" href="#References">References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#generalized-roy-model">Generalized Roy model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#regression-discontinuity-design">Regression discontinuity design</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../handouts/index.html">Handouts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects/index.html">Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../datasets/index.html">Data sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../partners/index.html">Partners</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../organization/index.html">Organization</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OSE data science</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Problem sets</a> &raquo;</li>
        
      <li>Regression and matching estimators in causal effects</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/problem-sets/matching-estimators/notebook.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="admonition note">
<p>Download the notebook <a class="reference download external" download="" href="https://nbviewer.jupyter.org/github/HumanCapitalAnalysis/ose-data-science/blob/master/problem-setsmatching-estimatorsnotebook.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>!
Interactive online version: <a class="reference external" href="https://mybinder.org/v2/gh/HumanCapitalAnalysis/ose-data-science/master?filepath=problem-setsmatching-estimatorsnotebook.ipynb"><img alt="binder" src="https://mybinder.org/badge_logo.svg" /></a></p>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">NearestNeighbors</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">ttest_ind</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:,.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
<div class="section" id="Regression-and-matching-estimators-in-causal-effects">
<h1>Regression and matching estimators in causal effects<a class="headerlink" href="#Regression-and-matching-estimators-in-causal-effects" title="Permalink to this headline">¶</a></h1>
<p><em>In this problem set we are going to compare the consistency of regression and matching estimators of causal effects based on Dehejia &amp; Wahba (1999). For that we employ the experimental study from LaLonde (1986), which provides an opportunity to estimate true treatment effects. We then use these results to evaluate the performance of (treatment effect) estimators one can usuallly obtain in observational studies.</em></p>
<p><em>LaLonde (1986) implements the data from the National Supported Work program (NSW) – temporary employment program designed to help disadvantaged workers lacking basic job skills move into the labor market by giving them work experience and counseling in sheltered environment. Unlike other federally sponsored employment programs, the NSW program assigned qualiffed applications randomly. Those assigned to the treatment group received all the bene ts of the NSW program, while those assigned to the
control group were left to fend for themselves.</em></p>
<p><em>To produce the observational study, we select the sample from the Current Population Survey (CPS) as the comparison group and merge it with the treatment group. We do this to obtain a data set which resembles the data which is commonly used in scientific practice. The two data sets are explained below:</em></p>
<p><em>-</em><strong>nsw_dehejia.csv</strong><em>is field-experiment data from the NSW. It contains variables as education, age, ethnicity, marital status, preintervention (1975) and postintervention (1978) earnings of the eligible male applicants. Dehejia &amp; Wahba (1999) also transform the LaLonde (1986) data set to have observations on preintervention 1974 earnings; motivation is explained in their paper.</em></p>
<p><em>-</em><strong>cps.csv</strong><em>is a non-experimental sample from the CPS which selects all males under age 55 and contains the same range of variables.</em></p>
<div class="section" id="Task-A">
<h2>Task A<a class="headerlink" href="#Task-A" title="Permalink to this headline">¶</a></h2>
<p><em>Create the table with the sample means of characteristics by age, education, preintervention earnings, etc. for treated and control groups of NSW sample (you can use the Table 1 from Dehejia and Wahba (1999) as a benchmark). Is the distribution of preintervention variables similar across the treatment and control groups? Check the differences on significance. Add to the table the CPS sample means. Is the comparison group different from the treatment group in terms of age, marital status,
ethnicity, and preintervention earnings?</em></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">demographics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;ed&quot;</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;hisp&quot;</span><span class="p">,</span> <span class="s2">&quot;married&quot;</span><span class="p">,</span> <span class="s2">&quot;nodeg&quot;</span><span class="p">,</span> <span class="s2">&quot;age2&quot;</span><span class="p">]</span>

<span class="n">dtypes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;treat&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">demographics</span><span class="p">:</span>
    <span class="n">dtypes</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span>

<span class="n">df_nsw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/nsw_dehejia.csv&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">)</span>
<span class="n">df_nsw</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;individual&quot;</span>
<span class="n">df_nsw</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>treat</th>
      <th>age</th>
      <th>ed</th>
      <th>black</th>
      <th>hisp</th>
      <th>married</th>
      <th>nodeg</th>
      <th>re74</th>
      <th>re75</th>
      <th>re78</th>
      <th>age2</th>
    </tr>
    <tr>
      <th>individual</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>37</td>
      <td>11</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>9,930.05</td>
      <td>1369</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>22</td>
      <td>9</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>3,595.89</td>
      <td>484</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>30</td>
      <td>12</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>24,909.45</td>
      <td>900</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>27</td>
      <td>11</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>7,506.15</td>
      <td>729</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>33</td>
      <td>8</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>289.79</td>
      <td>1089</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>How does a summary of the data look like?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df_nsw</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>treat</th>
      <th>age</th>
      <th>ed</th>
      <th>black</th>
      <th>hisp</th>
      <th>married</th>
      <th>nodeg</th>
      <th>re74</th>
      <th>re75</th>
      <th>re78</th>
      <th>age2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>445.00</td>
      <td>445.00</td>
      <td>445.00</td>
      <td>445.00</td>
      <td>445.00</td>
      <td>445.00</td>
      <td>445.00</td>
      <td>445.00</td>
      <td>445.00</td>
      <td>445.00</td>
      <td>445.00</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.42</td>
      <td>25.37</td>
      <td>10.20</td>
      <td>0.83</td>
      <td>0.09</td>
      <td>0.17</td>
      <td>0.78</td>
      <td>2,102.27</td>
      <td>1,377.14</td>
      <td>5,300.76</td>
      <td>693.98</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.49</td>
      <td>7.10</td>
      <td>1.79</td>
      <td>0.37</td>
      <td>0.28</td>
      <td>0.37</td>
      <td>0.41</td>
      <td>5,363.58</td>
      <td>3,150.96</td>
      <td>6,631.49</td>
      <td>429.78</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.00</td>
      <td>17.00</td>
      <td>3.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>289.00</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>0.00</td>
      <td>20.00</td>
      <td>9.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>400.00</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.00</td>
      <td>24.00</td>
      <td>10.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>3,701.81</td>
      <td>576.00</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>1.00</td>
      <td>28.00</td>
      <td>11.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>824.39</td>
      <td>1,220.84</td>
      <td>8,124.72</td>
      <td>784.00</td>
    </tr>
    <tr>
      <th>max</th>
      <td>1.00</td>
      <td>55.00</td>
      <td>16.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>39,570.68</td>
      <td>25,142.24</td>
      <td>60,307.93</td>
      <td>3,025.00</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Let’s look at the mean differences by treatment status.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df_nsw</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;treat&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>ed</th>
      <th>black</th>
      <th>hisp</th>
      <th>married</th>
      <th>nodeg</th>
      <th>re74</th>
      <th>re75</th>
      <th>re78</th>
      <th>age2</th>
    </tr>
    <tr>
      <th>treat</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>25.05</td>
      <td>10.09</td>
      <td>0.83</td>
      <td>0.11</td>
      <td>0.15</td>
      <td>0.83</td>
      <td>2,107.03</td>
      <td>1,266.91</td>
      <td>4,554.80</td>
      <td>677.32</td>
    </tr>
    <tr>
      <th>1</th>
      <td>25.82</td>
      <td>10.35</td>
      <td>0.84</td>
      <td>0.06</td>
      <td>0.19</td>
      <td>0.71</td>
      <td>2,095.57</td>
      <td>1,532.06</td>
      <td>6,349.14</td>
      <td>717.39</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Are these differences statistically significant?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">demographics</span><span class="p">:</span>

    <span class="n">treated</span> <span class="o">=</span> <span class="n">df_nsw</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;treat == 1&quot;</span><span class="p">)[</span><span class="n">column</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">df_nsw</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;treat == 0&quot;</span><span class="p">)[</span><span class="n">column</span><span class="p">]</span>

    <span class="n">stat</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">:</span><span class="s2">&lt;7</span><span class="si">}</span><span class="s2">     </span><span class="si">{</span><span class="n">stat</span><span class="si">:</span><span class="s2">7.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
age           0.265
ed            0.135
black         0.649
hisp          0.076
married       0.327
nodeg         0.001
age2          0.333
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df_cps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/cps.csv&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">)</span>
<span class="n">df_cps</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;individual&quot;</span>
<span class="n">df_cps</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>treat</th>
      <th>age</th>
      <th>ed</th>
      <th>black</th>
      <th>hisp</th>
      <th>married</th>
      <th>nodeg</th>
      <th>re74</th>
      <th>re75</th>
      <th>re78</th>
      <th>age2</th>
    </tr>
    <tr>
      <th>individual</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>45</td>
      <td>11</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>21,516.67</td>
      <td>25,243.55</td>
      <td>25,564.67</td>
      <td>2025</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>21</td>
      <td>14</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3,175.97</td>
      <td>5,852.56</td>
      <td>13,496.08</td>
      <td>441</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>38</td>
      <td>12</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>23,039.02</td>
      <td>25,130.76</td>
      <td>25,564.67</td>
      <td>1444</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>48</td>
      <td>6</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>24,994.37</td>
      <td>25,243.55</td>
      <td>25,564.67</td>
      <td>2304</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>18</td>
      <td>8</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1,669.30</td>
      <td>10,727.61</td>
      <td>9,860.87</td>
      <td>324</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>How does a summary of the data look like?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df_nsw</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>treat</th>
      <th>age</th>
      <th>ed</th>
      <th>black</th>
      <th>hisp</th>
      <th>married</th>
      <th>nodeg</th>
      <th>re74</th>
      <th>re75</th>
      <th>re78</th>
      <th>age2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>445.00</td>
      <td>445.00</td>
      <td>445.00</td>
      <td>445.00</td>
      <td>445.00</td>
      <td>445.00</td>
      <td>445.00</td>
      <td>445.00</td>
      <td>445.00</td>
      <td>445.00</td>
      <td>445.00</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.42</td>
      <td>25.37</td>
      <td>10.20</td>
      <td>0.83</td>
      <td>0.09</td>
      <td>0.17</td>
      <td>0.78</td>
      <td>2,102.27</td>
      <td>1,377.14</td>
      <td>5,300.76</td>
      <td>693.98</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.49</td>
      <td>7.10</td>
      <td>1.79</td>
      <td>0.37</td>
      <td>0.28</td>
      <td>0.37</td>
      <td>0.41</td>
      <td>5,363.58</td>
      <td>3,150.96</td>
      <td>6,631.49</td>
      <td>429.78</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.00</td>
      <td>17.00</td>
      <td>3.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>289.00</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>0.00</td>
      <td>20.00</td>
      <td>9.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>400.00</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.00</td>
      <td>24.00</td>
      <td>10.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>3,701.81</td>
      <td>576.00</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>1.00</td>
      <td>28.00</td>
      <td>11.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>824.39</td>
      <td>1,220.84</td>
      <td>8,124.72</td>
      <td>784.00</td>
    </tr>
    <tr>
      <th>max</th>
      <td>1.00</td>
      <td>55.00</td>
      <td>16.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>39,570.68</td>
      <td>25,142.24</td>
      <td>60,307.93</td>
      <td>3,025.00</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Let’s compare mean differences between the synthetic control group and the treatment group.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">demographics</span><span class="p">:</span>

    <span class="n">treated</span> <span class="o">=</span> <span class="n">df_nsw</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;treat == 1&quot;</span><span class="p">)[</span><span class="n">column</span><span class="p">]</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">df_cps</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>

    <span class="n">stat</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="n">treated</span><span class="p">,</span> <span class="n">control</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">:</span><span class="s2">&lt;7</span><span class="si">}</span><span class="s2">     </span><span class="si">{</span><span class="n">stat</span><span class="si">:</span><span class="s2">7.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
age           0.000
ed            0.000
black         0.000
hisp          0.510
married       0.000
nodeg         0.000
age2          0.000
</pre></div></div>
</div>
</div>
<div class="section" id="Task-B.-Regression-Adjustment">
<h2>Task B. Regression Adjustment<a class="headerlink" href="#Task-B.-Regression-Adjustment" title="Permalink to this headline">¶</a></h2>
<p><em>In this section we compare the results of regression estimates with selection on observables as discussed in the lecture 6.</em></p>
<div class="section" id="Task-B.1">
<h3>Task B.1<a class="headerlink" href="#Task-B.1" title="Permalink to this headline">¶</a></h3>
<p><em>Merge the treatment group data from the NSW sample with the comparison group data from the CPS sample to imitate an observational study.</em></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df_nsw</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NSW&quot;</span>
<span class="n">df_cps</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;CPS&quot;</span>

<span class="n">df_obs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_nsw</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;treat == 1&quot;</span><span class="p">),</span> <span class="n">df_cps</span><span class="p">])</span>
<span class="n">df_obs</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;sample&quot;</span><span class="p">],</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_obs</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">df_obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="s2">&quot;NSW&quot;</span><span class="p">),</span> <span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>treat</th>
      <th>age</th>
      <th>ed</th>
      <th>black</th>
      <th>hisp</th>
      <th>married</th>
      <th>nodeg</th>
      <th>re74</th>
      <th>re75</th>
      <th>re78</th>
      <th>age2</th>
    </tr>
    <tr>
      <th>individual</th>
      <th>sample</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <th>NSW</th>
      <td>1</td>
      <td>22</td>
      <td>9</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>3,595.89</td>
      <td>484</td>
    </tr>
    <tr>
      <th>2</th>
      <th>NSW</th>
      <td>1</td>
      <td>30</td>
      <td>12</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>24,909.45</td>
      <td>900</td>
    </tr>
    <tr>
      <th>3</th>
      <th>NSW</th>
      <td>1</td>
      <td>27</td>
      <td>11</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>7,506.15</td>
      <td>729</td>
    </tr>
    <tr>
      <th>4</th>
      <th>NSW</th>
      <td>1</td>
      <td>33</td>
      <td>8</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>289.79</td>
      <td>1089</td>
    </tr>
    <tr>
      <th>5</th>
      <th>NSW</th>
      <td>1</td>
      <td>22</td>
      <td>9</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>4,056.49</td>
      <td>484</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>
<div class="section" id="Task-B.2">
<h3>Task B.2<a class="headerlink" href="#Task-B.2" title="Permalink to this headline">¶</a></h3>
<p><em>Which assumption need to hold such that conditioning on observables can help in obtaining an unbiased estimate of the true treatment effect?</em></p>
<div class="math notranslate nohighlight">
\[E[Y^1|D = 1, S] = E[Y^1|D = 0, S]\]</div>
<div class="math notranslate nohighlight">
\[E[Y^0|D = 1, S] = E[Y^0|D = 0, S]\]</div>
</div>
<div class="section" id="Task-B.3">
<h3>Task B.3<a class="headerlink" href="#Task-B.3" title="Permalink to this headline">¶</a></h3>
<p><em>Run a regression on both experimental and non-experimental data using the specification: RE78 on a constant, a treatment indicator, age, age2, education, marital status, no degree, black, hispanic, RE74, and RE75. We recommend using statsmodels, but you are free to use any other software. Is the treatment effect estimate of the observational study consistent with the true estimate?</em></p>
<p>We first construct the regression equation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">indep_vars</span> <span class="o">=</span> <span class="n">df_obs</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">indep_vars</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;re78&quot;</span><span class="p">)</span>

<span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;re78 ~ &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="s2">&quot; + &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indep_vars</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now we can run the model on both datasets.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="p">[(</span><span class="s2">&quot;observational&quot;</span><span class="p">,</span> <span class="n">df_obs</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;experimental&quot;</span><span class="p">,</span> <span class="n">df_nsw</span><span class="p">)]:</span>
    <span class="n">stat</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;treat&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimate based on </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> data: </span><span class="si">{</span><span class="n">stat</span><span class="si">:</span><span class="s2">7.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Estimate based on observational data: 793.587
Estimate based on experimental data: 1675.862
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Task-C.-Matching-on-Propensity-Score">
<h2>Task C. Matching on Propensity Score<a class="headerlink" href="#Task-C.-Matching-on-Propensity-Score" title="Permalink to this headline">¶</a></h2>
<p><em>Recall that the propensity score p(Si) is the probability of unit i having been assigned to treatment. Most commonly this function is modeled to be dependent on various covariates. We write :math:`p(S_i) := Pr(D_i = 1|S_i) = E(D_i|S_i).` One assumption that makes estimation strategies feasible is :math:`S_i perp D_i|p(S_i)` which means that, conditional on the propensity score, the covariates are independent of assignment to treatment. Therefore, conditioning on the propensity score, each
individual has the same probability of assignment to treatment, as in a randomized experiment.</em></p>
<p><em>Estimation is done in two steps. First, we estimate the propensity score using a logistic regression model. Secondly, we match the observations on propensity score employing nearest-neighbor algorithm discussed in the lecture 5. That is, each treatment unit is matched to the comparison unit with the closest propensity score – the unmatched comparison units are discarded.</em></p>
<div class="section" id="Task-C.1">
<h3>Task C.1<a class="headerlink" href="#Task-C.1" title="Permalink to this headline">¶</a></h3>
<p><em>Before we start with matching on propensity score, let’s come back to another matching strategy which was discussed in Lecture 5 - matching on stratification. Looking at the data could you name at least two potential reasons why matching on stratification might be impossible to use here?</em></p>
<p>Data contains continuous variables; formed stratas might not have treated and control units available at the same time.</p>
</div>
<div class="section" id="Task-C.2">
<h3>Task C.2<a class="headerlink" href="#Task-C.2" title="Permalink to this headline">¶</a></h3>
<p><em>Employing our imitated observational data run a logistic regression on the following specification: treatment indicator on age, education, marital status, no degree, black, hispanic, RE74, and RE75. Use, for example, :nbsphinx-math:`texttt{statsmodels}` for this task. Then extract a propensity score for every individual as a probability to be assigned into treatment.</em></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">formula</span> <span class="o">=</span> <span class="s2">&quot;treat ~ age + ed + black + hisp + married + nodeg + re74 + re75&quot;</span>
<span class="n">df_obs</span><span class="p">[</span><span class="s2">&quot;pscore&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">logit</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_obs</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">predict</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Optimization terminated successfully.
         Current function value: 0.031035
         Iterations 12
</pre></div></div>
</div>
</div>
<div class="section" id="Task-C.3">
<h3>Task C.3<a class="headerlink" href="#Task-C.3" title="Permalink to this headline">¶</a></h3>
<p><em>Before proceeding further we have to be sure that propensity scores of treatment units overlap with the propensity scores of control units. Draw a figure showing the distribution of propensity score across treatment and control units (we use the packages matplotlib and seaborn). Do we observe common support?</em></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="k">for</span> <span class="n">treat</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;control&quot;</span><span class="p">,</span> <span class="s2">&quot;treated&quot;</span><span class="p">]):</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">df_obs</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;treat == </span><span class="si">{</span><span class="n">treat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="s2">&quot;pscore&quot;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Propensity scores&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f4b6ae12390&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/problem-sets_matching-estimators_notebook_39_1.png" src="../../_images/problem-sets_matching-estimators_notebook_39_1.png" />
</div>
</div>
</div>
<div class="section" id="Task-C.4">
<h3>Task C.4<a class="headerlink" href="#Task-C.4" title="Permalink to this headline">¶</a></h3>
<p><em>Match each treatment unit with control unit one-to-one with replacement. We use the package sklearn.neighbors: apply the algorithm NearestNeighbors to the propensity score of treated and control units and extract the indices of matched control units.</em></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">get_matched_dataset</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">training_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;treat == 0&quot;</span><span class="p">)[</span><span class="s2">&quot;pscore&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">eval_point</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;treat == 1&quot;</span><span class="p">)[</span><span class="s2">&quot;pscore&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">neigh</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">neigh</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">training_data</span><span class="p">)</span>
    <span class="n">matched</span> <span class="o">=</span> <span class="n">neigh</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="n">eval_point</span><span class="p">,</span> <span class="n">return_distance</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">df_treated</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;treat == 1&quot;</span><span class="p">)</span>
    <span class="n">df_matched</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;treat == 0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">matched</span><span class="p">]</span>

    <span class="n">df_sample</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_treated</span><span class="p">,</span> <span class="n">df_matched</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">df_sample</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Task-C.5">
<h3>Task C.5<a class="headerlink" href="#Task-C.5" title="Permalink to this headline">¶</a></h3>
<p><em>Construct new data set with matched observations. Run the regression to obtain matching on propensity score estimate. Is it more or less consistent estimate of the true effect comparing to the regression estimate with selection on observables? How could you explain this result?</em></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df_sample</span> <span class="o">=</span> <span class="n">get_matched_dataset</span><span class="p">(</span><span class="n">df_obs</span><span class="p">)</span>
<span class="n">stat</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="s2">&quot;re78 ~ treat&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_sample</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;treat&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimate based on matched for re78 data: </span><span class="si">{</span><span class="n">stat</span><span class="si">:</span><span class="s2">7.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Estimate based on matched for re78 data: 1551.477
</pre></div></div>
</div>
<p>Regression model neglects important nonlinear terms and interactions (Rubin 1973). The benefit of matching over regression is that it is non-parametric (but you do have to assume that you have the right propensity score specification in case of matching).</p>
<p>Let’s further explore two selected issues in matching, i.e. the use of placebo testing and trimming.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">stat</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="s2">&quot;re75 ~ treat&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_sample</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;treat&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimate based on matched for re75 data: </span><span class="si">{</span><span class="n">stat</span><span class="si">:</span><span class="s2">7.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Estimate based on matched for re75 data: 221.917
</pre></div></div>
</div>
<p>What happens if we trim our dataset?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">]:</span>

    <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">value</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">value</span>
    <span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df_obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_obs</span><span class="p">[</span><span class="s2">&quot;pscore&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">),</span> <span class="p">:]</span>

    <span class="n">df_sample</span> <span class="o">=</span> <span class="n">get_matched_dataset</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span>

    <span class="n">stat</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="s2">&quot;re78 ~ treat&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_sample</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;treat&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">5.3f</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">stat</span><span class="si">:</span><span class="s2">7.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.025: 1563.983
0.050: 1665.306
0.100: 1744.330
0.150: 2138.977
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="References">
<h2>References<a class="headerlink" href="#References" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Bureau of Labor Statistics. (1974, 1975, 1978). <a class="reference external" href="https://www.census.gov/programs-surveys/cps.html">Current Population Survey</a>.</p></li>
<li><p>Dehejia, R., and Wahba, S. (1999). <a class="reference external" href="https://www.jstor.org/stable/2669919?seq=1">Causal effects in nonexperimental studies: Reevaluating the evaluation of training programs</a>. <em>Journal of the American Statistical Association, 94</em>(448), 1053-1062.</p></li>
<li><p>LaLonde, R. J. (1986). <a class="reference external" href="https://www.jstor.org/stable/1806062?seq=1">Evaluating the econometric evaluation of training programs with experimental data</a>. <em>American Economic Review, 76</em>(4), 604-620.</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../generalized-roy-model/notebook.html" class="btn btn-neutral float-right" title="Generalized Roy Model" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../potential-outcome-model/notebook.html" class="btn btn-neutral float-left" title="Potential outcome model" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Prof. Dr. Philipp Eisenhauer.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
