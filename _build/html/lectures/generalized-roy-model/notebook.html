

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>The Generalized Roy Model &mdash; OSE data science  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Mechanisms and causal explanation" href="../mechanisms-causal-explanation/notebook.html" />
    <link rel="prev" title="Instrumental variable estimators of causal effects" href="../instrumental-variable/notebook.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> OSE data science
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Lectures</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#potential-outcome-model">Potential outcome model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#causal-graphs">Causal graphs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#conditioning-estimators">Conditioning estimators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#matching-estimators">Matching estimators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#regression-estimators">Regression estimators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#heterogeneity-selection-and-causal-graphs">Heterogeneity, selection, and causal graphs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#instrumental-variables">Instrumental variables</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#generalized-roy-model">Generalized Roy model</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">The Generalized Roy Model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#General-Framwork">General Framwork</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Heterogeneity">Heterogeneity</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Parameters-of-Interest">Parameters of Interest</a></li>
<li class="toctree-l4"><a class="reference internal" href="#The-Marginal-Treatment-Effec">The Marginal Treatment Effec</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Estimation-strategies">Estimation strategies</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#causal-explanations">Causal explanations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#repeated-observations">Repeated observations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#regression-discontinuity-design">Regression discontinuity design</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#generalized-method-of-moments">Generalized method of moments</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../problem-sets/index.html">Problem sets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../handouts/index.html">Handouts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects/index.html">Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../datasets/index.html">Data sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../partners/index.html">Partners</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../organization/index.html">Organization</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OSE data science</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Lectures</a> &raquo;</li>
        
      <li>The Generalized Roy Model</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/lectures/generalized-roy-model/notebook.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="admonition note">
<p>Download the notebook <a class="reference download external" download="" href="https://nbviewer.jupyter.org/github/HumanCapitalAnalysis/ose-data-science/blob/master/lecturesgeneralized-roy-modelnotebook.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">here</span></code></a>!
Interactive online version: <a class="reference external" href="https://mybinder.org/v2/gh/HumanCapitalAnalysis/ose-data-science/master?filepath=lecturesgeneralized-roy-modelnotebook.ipynb"><img alt="binder" src="https://mybinder.org/badge_logo.svg" /></a></p>
</div>
<div class="section" id="The-Generalized-Roy-Model">
<h1>The Generalized Roy Model<a class="headerlink" href="#The-Generalized-Roy-Model" title="Permalink to this headline">¶</a></h1>
<div class="section" id="General-Framwork">
<h2>General Framwork<a class="headerlink" href="#General-Framwork" title="Permalink to this headline">¶</a></h2>
<p><span class="math">\begin{align*}
&\textbf{Potential Outcomes} & & \textbf{Choice}  &\\
& Y_{1,i} = \mu_1(X_i) + U_{1,i} &  &C_i = \mu_C(Z_i) - V &\\
& Y_{0,i} = \mu_0(X_i) + U_{0,i} &  & D_i = \left\{
\begin{array}{ll}
1 & if \ C_i > 0 \\
0 &  \text{otherwise}\\
\end{array}
\right.  &\\
&&&&\\
&\textbf{Distributional Characteristics}&&&\\
&\{U_{1}, U_{0}, V\} \sim \left(0, \Sigma\right)&&&\\
&&&&\\
& \textbf{Observed Outcome} &&&\\
& Y_i = D_i Y_{1,i} + (1-D_i) Y_{0,i} &&&
\end{align*}</span></p>
<div class="section" id="Choice-Process">
<h3>Choice Process<a class="headerlink" href="#Choice-Process" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(Z_i\)</span> captures all observable factors that affect the decision of an individual to select itself into treatment</p></li>
<li><p><span class="math notranslate nohighlight">\(V_i\)</span> denotes (from perspective of the econometrician) unobservable components that drive the selection decision (Note: V enters with a negative sign <span class="math notranslate nohighlight">\(\Rightarrow\)</span> conditional on <span class="math notranslate nohighlight">\(Z_i\)</span>, high values of <span class="math notranslate nohighlight">\(V_i\)</span> indicate a lower propensity to select into treatment</p></li>
<li><p><span class="math notranslate nohighlight">\(C_i\)</span> is the latent propensity indicator of individual <span class="math notranslate nohighlight">\(i\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(D_i\)</span> indicates whether an individual selects itself in the treatment group</p></li>
<li><p>Furthermore we can rearrange <span class="math notranslate nohighlight">\(D_i\)</span> s.t. the individual selects into treatment if</p></li>
</ul>
<p><span class="math">\begin{align*}
&\;\mu_C(Z_i) > V_i\\
\Leftrightarrow&\;F_V(\mu_C(Z_i)) > F_V(V_i)\\
&\\
\Rightarrow& \; D_i = \mathbb{1}\{F_V(\mu_C(Z_i)) > F_V(V_i)\}
\end{align*}</span></p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(F_V(\mu_C(Z_i))\)</span>: Probability of being treated given an individual’s observable characteristics (propensity score)</p></li>
<li><p><span class="math notranslate nohighlight">\(F_V(V_i)\)</span>: The quantile of <span class="math notranslate nohighlight">\(V\)</span>’s distribution the individual’s realization <span class="math notranslate nohighlight">\(V_i\)</span> is located in</p></li>
</ul>
<p><span class="math notranslate nohighlight">\(\Rightarrow\)</span> <strong>The individuals select themselves into treatment when their propensity score outruns the quantile of the distribution :math:`V_i`</strong></p>
</div>
<div class="section" id="Outcomes">
<h3>Outcomes<a class="headerlink" href="#Outcomes" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\((Y_{1,i}, Y_{0,i})\)</span> denotes the set of potential outcomes of individual <span class="math notranslate nohighlight">\(i\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(Y_i\)</span> denotes the observable outcome of individual <span class="math notranslate nohighlight">\(i\)</span></p></li>
<li><p>Rearranging the outcome equation leads to:</p></li>
</ul>
<p><span class="math">\begin{align*}
Y_i = Y_{0,i} + D_i \underbrace{(Y_{1,i} - Y_{0,i})}_{\Delta_i}
\end{align*}</span></p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\Delta_i\)</span> : Causal effect of treatment for individual <span class="math notranslate nohighlight">\(i\)</span></p></li>
</ul>
<p><strong>Evaluation Problem</strong></p>
<p>The set of equations above entails one of the most crucial challenges for the evaluation of policy interventions. We as researchers are not able to observe the potential outcome space for an individual but instead we observe either <span class="math notranslate nohighlight">\(Y_{1,i}\)</span> or <span class="math notranslate nohighlight">\(Y_{0,i}\)</span> for one and the same individual dependent on the individual’s selection decision. This is referred to as the <strong>evaluation problem</strong>.</p>
</div>
</div>
<div class="section" id="Heterogeneity">
<h2>Heterogeneity<a class="headerlink" href="#Heterogeneity" title="Permalink to this headline">¶</a></h2>
<p>Central question in all econometrics of policy analysis:</p>
<p><em>What gives rise to variation and outcomes among, from the econometrician’s perspective, otherwise identical agents?</em> (Heckman 2001)</p>
<p><strong>Answer: Heterogeneity</strong></p>
<p><span class="math">\begin{align*}
\Delta_i = Y_{1,i} - Y_{0,i} = \underbrace{\mu_1(X_i) - \mu_0(X_i)}_{\text{average effect}} + \underbrace{U_{1,i} -U_{0,i}}_{\text{individual specific effect}}
\end{align*}</span></p>
<ul class="simple">
<li><p><strong>Observable heterogeneity:</strong></p>
<ul>
<li><p>Is reflected by the first term of the equation.</p></li>
<li><p>Denotes the differences between individuals, which are based on differences in observable characteristics captured by <span class="math notranslate nohighlight">\(X_i\)</span></p></li>
<li><p>Note that since we observe <span class="math notranslate nohighlight">\(X_i\)</span>, we are able to</p></li>
</ul>
</li>
<li><p><strong>Unobservable heterogeneity:</strong></p>
<ul>
<li><p>Represented by the difference in the unobservables.</p></li>
<li><p>Note: The term <em>unobservable</em> does not imply that <span class="math notranslate nohighlight">\(U_{1,i}\)</span> and <span class="math notranslate nohighlight">\(U_{0,i}\)</span> are completely excluded in an individual’s information set.</p></li>
</ul>
</li>
</ul>
<p><strong>Question: When does unobservable heterogeneity pose problems in the analysis of average effect parameters?</strong></p>
<p><strong>Answer: If the individual’s selection process depends on unobservable “gains” we have a selection problem.</strong></p>
<p>This kind of heterogeneity is referred to as <strong>essential heterogeneity</strong> * The reaction on interventions are heterogeneous among individuals</p>
<ul class="simple">
<li><p>Individuals select their treatment state with at least partly knowledge of their own responses to treatment.</p></li>
</ul>
</div>
<div class="section" id="Parameters-of-Interest">
<h2>Parameters of Interest<a class="headerlink" href="#Parameters-of-Interest" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>In a perfect world we as economists would focus on determining <span class="math notranslate nohighlight">\(\Delta_i\)</span>. In reality this is impossible due to the aformentioned evaluation problem!</p></li>
<li><p>For this reason, the analysis of conventional treatment effect analysisis is confined to the identification of average effects for specific subgroups.</p></li>
<li><p>The common subgroups are the whole population (<span class="math notranslate nohighlight">\(\Delta^{ATE}\)</span>), the treated (<span class="math notranslate nohighlight">\(\Delta^{ATE}\)</span>) or the untreted share (<span class="math notranslate nohighlight">\(\Delta^{ATE}\)</span>). The effects are characterized by the following equations</p></li>
</ul>
<p><span class="math">\begin{align*}
\Delta^{ATE} &= E[Y_1 -Y_0] \\
\Delta^{TT}\;\; &= E[Y_1 -Y_0|D=1]\\
\Delta^{TUT} &= E[Y_1 -Y_0|D=0]
\end{align*}</span></p>
<ul class="simple">
<li><p>When treatment is randomly assigned or the selection is not based on the potential outcomes there is no significant difference between the average individuals with different treatment states.</p></li>
<li><p>Therefore all effects are identical! And we can substitute <span class="math notranslate nohighlight">\(E[Y_1]\)</span> and <span class="math notranslate nohighlight">\(E[Y_0]\)</span> with the observed average outcomes <span class="math notranslate nohighlight">\(E[Y_1|D=1]\)</span> and <span class="math notranslate nohighlight">\(E[Y_0|D=0]\)</span>.</p></li>
</ul>
<p><span class="math">\begin{align*}
\Delta^{ATE} =  \Delta^{TUT} =  \Delta^{TT} = E[Y_1|D=1] - E[Y_0|D=0]
\end{align*}</span></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%file</span> files/no_eh.grmpy.yml
<span class="o">---</span>
<span class="n">SIMULATION</span><span class="p">:</span>
    <span class="n">agents</span><span class="p">:</span> <span class="mi">10000</span>
    <span class="n">seed</span><span class="p">:</span> <span class="mi">2356</span>
    <span class="n">source</span><span class="p">:</span> <span class="n">data</span>
<span class="n">ESTIMATION</span><span class="p">:</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">grmpy</span><span class="o">.</span><span class="n">txt</span>
    <span class="n">output_file</span><span class="p">:</span> <span class="n">output</span><span class="o">/</span><span class="n">est</span><span class="o">.</span><span class="n">grmpy</span><span class="o">.</span><span class="n">info</span>
    <span class="n">dependent</span><span class="p">:</span> <span class="n">Y</span>
    <span class="n">indicator</span><span class="p">:</span> <span class="n">D</span>
<span class="n">TREATED</span><span class="p">:</span>
    <span class="n">params</span><span class="p">:</span>
    <span class="o">-</span> <span class="mf">1.0</span>
    <span class="o">-</span> <span class="mf">0.555</span>
    <span class="n">order</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">const</span>
    <span class="o">-</span> <span class="n">X2</span>
<span class="n">UNTREATED</span><span class="p">:</span>
    <span class="n">params</span><span class="p">:</span>
    <span class="o">-</span> <span class="mf">0.5</span>
    <span class="o">-</span> <span class="mf">0.25</span>
    <span class="n">order</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">const</span>
    <span class="o">-</span> <span class="n">X2</span>
<span class="n">CHOICE</span><span class="p">:</span>
    <span class="n">params</span><span class="p">:</span>
    <span class="o">-</span> <span class="mf">0.378</span>
    <span class="o">-</span> <span class="o">-</span><span class="mf">0.39</span>
    <span class="n">order</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">const</span>
    <span class="o">-</span> <span class="n">X3</span>
<span class="n">DIST</span><span class="p">:</span>
    <span class="n">params</span><span class="p">:</span>
    <span class="o">-</span> <span class="mf">0.2</span>
    <span class="o">-</span> <span class="mf">0.0</span>
    <span class="o">-</span> <span class="mf">0.</span>
    <span class="o">-</span> <span class="mf">0.2</span>
    <span class="o">-</span> <span class="mf">0.0</span>
    <span class="o">-</span> <span class="mf">1.0</span>
<span class="n">VARTYPES</span><span class="p">:</span>
    <span class="n">const</span><span class="p">:</span> <span class="n">nonbinary</span>
    <span class="n">X2</span><span class="p">:</span> <span class="n">nonbinary</span>
    <span class="n">X3</span><span class="p">:</span> <span class="n">nonbinary</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Overwriting files/no_eh.grmpy.yml
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span> <span class="o">=</span> <span class="n">grmpy</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="s2">&quot;files/no_eh.grmpy.yml&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">indicator</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">D</span> <span class="o">==</span> <span class="mi">1</span>
<span class="n">Delta</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y0&quot;</span><span class="p">]</span>
<span class="n">ATE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y0&quot;</span><span class="p">])</span>
<span class="n">TT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">indicator</span><span class="p">][</span><span class="s2">&quot;Y1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">indicator</span><span class="p">][</span><span class="s2">&quot;Y0&quot;</span><span class="p">])</span>
<span class="n">TUT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">indicator</span><span class="p">][</span><span class="s2">&quot;Y1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">indicator</span><span class="p">][</span><span class="s2">&quot;Y0&quot;</span><span class="p">])</span>


<span class="n">effect_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">indicator</span><span class="p">][</span><span class="s2">&quot;Y&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">indicator</span><span class="p">][</span><span class="s2">&quot;Y&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># set up figure object</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$f_{Y_1 - Y_0}$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$Y_1 - Y_0$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.31</span><span class="p">])</span>

<span class="c1"># plot distribution of individual effects</span>
<span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">Delta</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># plot average effect parameters</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">ATE</span><span class="p">,</span> <span class="n">ATE</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$\Delta^</span><span class="si">{ATE}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">TT</span><span class="p">,</span> <span class="n">TT</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$\Delta^</span><span class="si">{TT}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">TUT</span><span class="p">,</span> <span class="n">TUT</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$\Delta^</span><span class="si">{TUT}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">effect_est</span><span class="p">,</span> <span class="n">effect_est</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$\hat{\Delta}$&quot;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f34ab618bd0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/lectures_generalized-roy-model_notebook_16_1.png" src="../../_images/lectures_generalized-roy-model_notebook_16_1.png" />
</div>
</div>
<ul class="simple">
<li><p>The figure should not lead to the false assumptions that all introduced parameters measure the same effect.</p></li>
<li><p>If individuals select themselves into treatment based on outcome related characteristics (the potential outcomes <span class="math notranslate nohighlight">\(Y-1, Y_0\)</span> are no longer independent of the treatment status <span class="math notranslate nohighlight">\(D\)</span>), we can observe differences between the parameters.</p></li>
<li><p>These differences are linked to the selection process. Unlike in the abscence of essential heterogeneity, individuals who select themselves into treatment differ inherently from individuals who do not in respect of their unobservable characteristics.</p></li>
</ul>
<p><span class="math">\begin{align*}
E[Y_1|D=1] - E[Y_0|D=0] = \underbrace{E[Y_1-Y_0]}_{\Delta^{ATE}} \\
+\underbrace{E[Y_1 -Y_0|D=1] - E[Y_1-Y_0]}_{\text{selection on gains}} \\
+\underbrace{E[Y_0|D=1] - E[Y_0|D=0]}_{\text{selection on endowments}}
\end{align*}</span></p>
<p>The bias can be decomposed in two different components:</p>
<div class="line-block">
<div class="line"><strong>Selection on endowment bias</strong></div>
<div class="line">As indicated by the equation above, differences in endowments (<span class="math notranslate nohighlight">\(Y_0\)</span>) between treated and untreated individuals lead to a bias. This reflects that there exist difference in outcomes between the treated and untreated share of the population even without the treatment.</div>
</div>
<div class="line-block">
<div class="line"><strong>Selection on gains bias</strong></div>
<div class="line">The selection on gains bias illustrates that the average benefit for individuals who select themselves into treatment differs from the effect of treatment that do not.</div>
</div>
<p><strong>NOTE:</strong> The type of bias depends on the parameter of interest for which the effect should be measured.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%file</span> files/eh.grmpy.yml
<span class="o">---</span>
<span class="n">SIMULATION</span><span class="p">:</span>
    <span class="n">agents</span><span class="p">:</span> <span class="mi">10000</span>
    <span class="n">seed</span><span class="p">:</span> <span class="mi">2356</span>
    <span class="n">source</span><span class="p">:</span> <span class="n">data</span>
<span class="n">ESTIMATION</span><span class="p">:</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">grmpy</span><span class="o">.</span><span class="n">txt</span>
    <span class="n">output_file</span><span class="p">:</span> <span class="n">output</span><span class="o">/</span><span class="n">est</span><span class="o">.</span><span class="n">grmpy</span><span class="o">.</span><span class="n">info</span>
    <span class="n">dependent</span><span class="p">:</span> <span class="n">Y</span>
    <span class="n">indicator</span><span class="p">:</span> <span class="n">D</span>
<span class="n">TREATED</span><span class="p">:</span>
    <span class="n">params</span><span class="p">:</span>
    <span class="o">-</span> <span class="mf">1.0</span>
    <span class="o">-</span> <span class="mf">0.555</span>
    <span class="n">order</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">const</span>
    <span class="o">-</span> <span class="n">X2</span>
<span class="n">UNTREATED</span><span class="p">:</span>
    <span class="n">params</span><span class="p">:</span>
    <span class="o">-</span> <span class="mf">0.5</span>
    <span class="o">-</span> <span class="mf">0.25</span>
    <span class="n">order</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">const</span>
    <span class="o">-</span> <span class="n">X2</span>
<span class="n">CHOICE</span><span class="p">:</span>
    <span class="n">params</span><span class="p">:</span>
    <span class="o">-</span> <span class="mf">0.378</span>
    <span class="o">-</span> <span class="o">-</span><span class="mf">0.39</span>
    <span class="n">order</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">const</span>
    <span class="o">-</span> <span class="n">X3</span>
<span class="n">DIST</span><span class="p">:</span>
    <span class="n">params</span><span class="p">:</span>
    <span class="o">-</span> <span class="mf">0.2</span>
    <span class="o">-</span> <span class="mf">0.0</span>
    <span class="o">-</span> <span class="o">-</span><span class="mf">0.15</span>
    <span class="o">-</span> <span class="mf">0.2</span>
    <span class="o">-</span> <span class="mf">0.02</span>
    <span class="o">-</span> <span class="mf">1.0</span>
<span class="n">VARTYPES</span><span class="p">:</span>
    <span class="n">const</span><span class="p">:</span> <span class="n">nonbinary</span>
    <span class="n">X2</span><span class="p">:</span> <span class="n">nonbinary</span>
    <span class="n">X3</span><span class="p">:</span> <span class="n">nonbinary</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Overwriting files/eh.grmpy.yml
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df_eh</span> <span class="o">=</span> <span class="n">grmpy</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="s2">&quot;files/eh.grmpy.yml&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">indicator</span> <span class="o">=</span> <span class="n">df_eh</span><span class="o">.</span><span class="n">D</span> <span class="o">==</span> <span class="mi">1</span>
<span class="n">Delta</span> <span class="o">=</span> <span class="n">df_eh</span><span class="p">[</span><span class="s2">&quot;Y1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_eh</span><span class="p">[</span><span class="s2">&quot;Y0&quot;</span><span class="p">]</span>
<span class="n">ATE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">df_eh</span><span class="p">[</span><span class="s2">&quot;Y1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_eh</span><span class="p">[</span><span class="s2">&quot;Y0&quot;</span><span class="p">])</span>
<span class="n">TT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">df_eh</span><span class="p">[</span><span class="n">indicator</span><span class="p">][</span><span class="s2">&quot;Y1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_eh</span><span class="p">[</span><span class="n">indicator</span><span class="p">][</span><span class="s2">&quot;Y0&quot;</span><span class="p">])</span>
<span class="n">TUT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">df_eh</span><span class="p">[</span><span class="o">~</span><span class="n">indicator</span><span class="p">][</span><span class="s2">&quot;Y1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_eh</span><span class="p">[</span><span class="o">~</span><span class="n">indicator</span><span class="p">][</span><span class="s2">&quot;Y0&quot;</span><span class="p">])</span>

<span class="n">effect_estimate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">df_eh</span><span class="p">[</span><span class="n">indicator</span><span class="p">][</span><span class="s2">&quot;Y&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">df_eh</span><span class="p">[</span><span class="o">~</span><span class="n">indicator</span><span class="p">][</span><span class="s2">&quot;Y&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># set up figure object</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$f_{Y_1 - Y_0}$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$Y_1 - Y_0$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.31</span><span class="p">])</span>

<span class="c1"># plot distribution of individual effects</span>
<span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">Delta</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># plot average effect parameters</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">ATE</span><span class="p">,</span> <span class="n">ATE</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$\Delta^</span><span class="si">{ATE}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">TT</span><span class="p">,</span> <span class="n">TT</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$\Delta^</span><span class="si">{TT}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">TUT</span><span class="p">,</span> <span class="n">TUT</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$\Delta^</span><span class="si">{TUT}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">effect_estimate</span><span class="p">,</span> <span class="n">effect_estimate</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$\hat{\Delta}$&quot;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f34ab12ced0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/lectures_generalized-roy-model_notebook_21_1.png" src="../../_images/lectures_generalized-roy-model_notebook_21_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">g1</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">jointplot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;U1&quot;</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">set_axis_labels</span><span class="p">(</span>
    <span class="s2">&quot;$V$&quot;</span><span class="p">,</span> <span class="s2">&quot;$U_1$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span>
<span class="p">)</span>
<span class="n">g1</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">g1</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Abscence of essential heterogeneity&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 0.98, &#39;Abscence of essential heterogeneity&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/lectures_generalized-roy-model_notebook_22_1.png" src="../../_images/lectures_generalized-roy-model_notebook_22_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">g2</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">jointplot</span><span class="p">(</span><span class="n">df_eh</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">],</span> <span class="n">df_eh</span><span class="p">[</span><span class="s2">&quot;U1&quot;</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">set_axis_labels</span><span class="p">(</span>
    <span class="s2">&quot;$V$&quot;</span><span class="p">,</span> <span class="s2">&quot;$U_1$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span>
<span class="p">)</span>
<span class="n">g2</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">g2</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Presence of essential heterogeneity&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 0.98, &#39;Presence of essential heterogeneity&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/lectures_generalized-roy-model_notebook_23_1.png" src="../../_images/lectures_generalized-roy-model_notebook_23_1.png" />
</div>
</div>
</div>
<div class="section" id="The-Marginal-Treatment-Effec">
<h2>The Marginal Treatment Effec<a class="headerlink" href="#The-Marginal-Treatment-Effec" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The concept was first introduced by Björklund &amp; Moffitt (1987) and advanced by a broad variety of papers by Heckman &amp; Vytlacil (1999, 2001, 2005, 2007)</p></li>
<li><p>It is defined as the effect of treatment for individuals who are indifferent between taking the treatment and not. In terms of the Roy model framework it is characterized by the following equation</p></li>
</ul>
<p><span class="math">\begin{align*}
\Delta^{MTE}(x,u_D) = E[Y_1 -Y_0|X=x, U_D=u_D]\\
\\
\end{align*}</span></p>
<ul class="simple">
<li><p>It can be interpreted as the <em>willingness to pay</em> for treatment participation of individuals with characteristics <span class="math notranslate nohighlight">\(Z_i=z\)</span> at the margin</p></li>
<li><p><strong>Note:</strong> Instead of explicitly assigning one value to a given policy intervention, <span class="math notranslate nohighlight">\(\Delta^{MTE}\)</span> provides a continuum of effects along the distribution of the unobservable variable <span class="math notranslate nohighlight">\(V\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(V_i\)</span> enters the choice function <span class="math notranslate nohighlight">\(D_i\)</span> with a negative sign <span class="math notranslate nohighlight">\(\Rightarrow\)</span> Individuals with <span class="math notranslate nohighlight">\(U_D\)</span> close to zero are most likely to select themselves into treatment.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># import init specifications</span>
<span class="n">spec</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="s2">&quot;files/no_eh.grmpy.yml&quot;</span><span class="p">)</span>
<span class="n">spec_eh</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="s2">&quot;files/eh.grmpy.yml&quot;</span><span class="p">)</span>

<span class="c1"># set up a figure object</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta^</span><span class="si">{MTE}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$u_D$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Without essential heterogeneity&quot;</span><span class="p">,</span> <span class="s2">&quot;With essential heterogeneity&quot;</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">]</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">,</span> <span class="n">df_eh</span><span class="p">]</span>

<span class="k">for</span> <span class="n">counter</span><span class="p">,</span> <span class="n">init_dict</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">spec</span><span class="p">,</span> <span class="n">spec_eh</span><span class="p">]):</span>

    <span class="c1"># assign parameters</span>
    <span class="n">beta1</span> <span class="o">=</span> <span class="n">init_dict</span><span class="p">[</span><span class="s2">&quot;TREATED&quot;</span><span class="p">][</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>
    <span class="n">beta0</span> <span class="o">=</span> <span class="n">init_dict</span><span class="p">[</span><span class="s2">&quot;UNTREATED&quot;</span><span class="p">][</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>
    <span class="n">cov1V</span> <span class="o">=</span> <span class="n">init_dict</span><span class="p">[</span><span class="s2">&quot;DIST&quot;</span><span class="p">][</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">cov0V</span> <span class="o">=</span> <span class="n">init_dict</span><span class="p">[</span><span class="s2">&quot;DIST&quot;</span><span class="p">][</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>

    <span class="c1"># define relevant dataset</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span>

    <span class="n">covariates</span> <span class="o">=</span> <span class="n">init_dict</span><span class="p">[</span><span class="s2">&quot;TREATED&quot;</span><span class="p">][</span><span class="s2">&quot;order&quot;</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">covariates</span><span class="p">])</span>

    <span class="n">quantiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>

    <span class="n">mte</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">beta1</span> <span class="o">-</span> <span class="n">beta0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cov1V</span> <span class="o">-</span> <span class="n">cov0V</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">quantiles</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">quantiles</span><span class="p">,</span> <span class="n">mte</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">counter</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">counter</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f34ab47a610&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/lectures_generalized-roy-model_notebook_26_1.png" src="../../_images/lectures_generalized-roy-model_notebook_26_1.png" />
</div>
</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\Delta^{MTE}\)</span> is constant in the absence of essential heterogeneity whereas decreasing respectively increasing values indicate the presence of essential heterogeneity. Why?</p></li>
<li><p>Additionally whether <span class="math notranslate nohighlight">\(\Delta^{MTE}\)</span> is increasing or decreasing along <span class="math notranslate nohighlight">\(u_D\)</span> provides information about which kind of selection on gains take place</p></li>
<li><p>In addition it is also possible to derive all conventional effects from <span class="math notranslate nohighlight">\(\Delta^{MTE}\)</span> by applying effect specific weights along the distribution of <span class="math notranslate nohighlight">\(V\)</span>:</p></li>
</ul>
<p><span class="math">\begin{align*}
\omega^{ATE}(x,u_D) &= 1.0\\
\omega^{TT}(x,u_D) &= \frac{\int_{u_D}^{1}f(p|X=x)dp}{E[P|X=x]}\\
\omega^{TUT}(x,u_D) &= \frac{\int_{0}^{u_D}f(p|X=x)dp}{E[1-P|X=x]}\\
\end{align*}</span></p>
<p>Formally:</p>
<p><span class="math">\begin{align*}
\Delta^j = \int_0^1 \omega_j(x,u_D) \Delta^{MTE}(x,u_D)du_D\\
\text{ for } j = \text{ ATE, TT, TUT}
\end{align*}</span></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># assign parameter and choice covariates</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="n">spec_eh</span><span class="p">[</span><span class="s2">&quot;CHOICE&quot;</span><span class="p">][</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">df_eh</span><span class="p">[</span><span class="n">spec_eh</span><span class="p">[</span><span class="s2">&quot;CHOICE&quot;</span><span class="p">][</span><span class="s2">&quot;order&quot;</span><span class="p">]]</span>

<span class="c1"># compute average propensity score as well as individual propensity score</span>
<span class="n">propensity_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>
<span class="n">auxiliary</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">Z</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

<span class="c1"># compute the integral</span>
<span class="n">integral_TT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">auxiliary</span> <span class="o">&gt;</span> <span class="n">quantiles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">quantiles</span><span class="p">))]</span>
<span class="p">)</span>
<span class="n">integral_TUT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">auxiliary</span> <span class="o">&gt;</span> <span class="n">quantiles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">quantiles</span><span class="p">))]</span>
<span class="p">)</span>

<span class="c1"># compute the weights</span>
<span class="n">omega_TT</span> <span class="o">=</span> <span class="n">integral_TT</span> <span class="o">/</span> <span class="n">propensity_mean</span>
<span class="n">omega_TUT</span> <span class="o">=</span> <span class="n">integral_TUT</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">propensity_mean</span><span class="p">)</span>
<span class="n">omega_ATE</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">quantiles</span><span class="p">)</span>


<span class="c1"># plot</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta^</span><span class="si">{MTE}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$u_D$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">quantiles</span><span class="p">,</span> <span class="n">mte</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot; $\Delta^</span><span class="si">{MTE}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>


<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">quantiles</span><span class="p">,</span>
    <span class="n">omega_TT</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot; $\omega^</span><span class="si">{TT}</span><span class="s2">$&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">quantiles</span><span class="p">,</span>
    <span class="n">omega_TUT</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot; $\omega^</span><span class="si">{TUT}</span><span class="s2">$&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">quantiles</span><span class="p">,</span>
    <span class="n">omega_ATE</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot; $\omega^</span><span class="si">{ATE}</span><span class="s2">$&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f34ab3e8bd0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/lectures_generalized-roy-model_notebook_28_1.png" src="../../_images/lectures_generalized-roy-model_notebook_28_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;      True Values  Weighted Values</span><span class="se">\n\n</span><span class="s2">ATE:</span><span class="si">{0:&gt;10.5f}{3:&gt;15.5f}</span><span class="se">\n</span><span class="s2">TT:</span><span class="si">{1:&gt;11.5f}{4:&gt;15.5f}</span><span class="se">\n</span><span class="s2">TUT:</span><span class="si">{2:&gt;10.5f}{5:&gt;15.5f}</span><span class="s2">&quot;</span>

<span class="c1"># Apply weights to the mte</span>
<span class="n">ATE_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mte</span><span class="p">),</span> <span class="n">omega_ATE</span><span class="p">))</span>
<span class="n">TT_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mte</span><span class="p">),</span> <span class="n">omega_TT</span><span class="p">))</span>
<span class="n">TUT_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mte</span><span class="p">),</span> <span class="n">omega_TUT</span><span class="p">))</span>
<span class="n">effects</span> <span class="o">=</span> <span class="p">[</span><span class="n">ATE</span><span class="p">,</span> <span class="n">TT</span><span class="p">,</span> <span class="n">TUT</span><span class="p">,</span> <span class="n">ATE_w</span><span class="p">,</span> <span class="n">TT_w</span><span class="p">,</span> <span class="n">TUT_w</span><span class="p">]</span>

<span class="c1"># print comparison to the true values</span>
<span class="nb">print</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">effects</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">Naive comparison: </span><span class="si">{:.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">effect_estimate</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
      True Values  Weighted Values

ATE:   0.50343        0.50062
TT:    0.59764        0.59144
TUT:   0.33638        0.33977



Naive comparison: 0.57154
</pre></div></div>
</div>
<div class="section" id="Link-to-Local-Average-Treatment-Effect">
<h3>Link to Local Average Treatment Effect<a class="headerlink" href="#Link-to-Local-Average-Treatment-Effect" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>The concept of the marginal treatment effect is closely related to the local average treatment effect (<span class="math notranslate nohighlight">\(\Delta^{LATE}\)</span>)</p></li>
<li><p>More specifically, it can be shown that <span class="math notranslate nohighlight">\(\Delta^{LATE}\)</span> converges to <span class="math notranslate nohighlight">\(\Delta^{MTE}\)</span>. It can be represented as follows:</p></li>
</ul>
<p><span class="math">\begin{align*}
\Delta^{LATE}(u_D, u^{'}_D x) = E[Y_1 -Y_0| u_D > U_D > u^{'}_D, X=x]
\end{align*}</span></p>
<ul class="simple">
<li><p>where <span class="math notranslate nohighlight">\(u_D\)</span> and <span class="math notranslate nohighlight">\(u'_D\)</span> are defined as the propensity scores for <span class="math notranslate nohighlight">\(Z=z\)</span> and <span class="math notranslate nohighlight">\(Z= z'\)</span> or equivalent as point in the unit interval of the distribution of <span class="math notranslate nohighlight">\(V\)</span></p></li>
<li><p>Taking the limit of <span class="math notranslate nohighlight">\(\Delta^{LATE}\)</span> as <span class="math notranslate nohighlight">\(u_D\)</span> approaches <span class="math notranslate nohighlight">\(u'_D\)</span> reduced the equation above to the definition of <span class="math notranslate nohighlight">\(\Delta^{MTE}\)</span>.</p></li>
<li><p>Therefore <span class="math notranslate nohighlight">\(\Delta^{LATE}\)</span> can be defined more generally as a function dependent of <span class="math notranslate nohighlight">\(\Delta^{MTE}\)</span>:</p></li>
</ul>
<p><span class="math">\begin{align*}
\Delta^{LATE} = \frac{1}{u_D - u'_D} \int_0^1\Delta^{MTE}(x,u_D) du_D
\end{align*}</span></p>
</div>
</div>
<div class="section" id="Estimation-strategies">
<h2>Estimation strategies<a class="headerlink" href="#Estimation-strategies" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>We will now compare different estimation strategies regarding their capability to evaluate the average effect of treatment in the presence of essential heterogeneity.</p></li>
<li><p>In particular we will compare results obtained by:</p>
<ul>
<li><p><strong>Naive comparison</strong></p></li>
<li><p><strong>Ordinary Least Squares</strong></p></li>
<li><p><strong>Instrumental Variables</strong></p>
<ul>
<li><p><strong>Conventional IV</strong></p></li>
<li><p><strong>Local IV</strong></p></li>
</ul>
</li>
</ul>
</li>
<li><p>For this purpose we will conduct a monte carlo simulation approach:</p>
<ul>
<li><p>We simulate a dataset of 10000 individuals</p></li>
<li><p>Compute <span class="math notranslate nohighlight">\(\mu_1(X_i)\)</span>, <span class="math notranslate nohighlight">\(\mu_0(X_i)\)</span>, <span class="math notranslate nohighlight">\(\mu_D(Z_i)\)</span> for all individuals</p></li>
<li><p>Each iteration of the monte calo simulation consists of three steps:</p>
<ul>
<li><p>We draw unobservable variables from a mutlivariate normal distribution with mean zero and covariance matrix <span class="math notranslate nohighlight">\(\Sigma\)</span>, which has the following form <span class="math">\begin{align*}
\\
\Sigma =  \begin{bmatrix}
0.01 & 0 & \frac{\rho_{1,V}}{0.1}  \\
0 & 0.01 & 0 \\
\frac{\rho_{1,V}}{0.1}  & 0 & 1 \\
\end{bmatrix}
\\
\\
\end{align*}</span></p></li>
<li><p>Next we combine the simulated unobservable variables with <span class="math notranslate nohighlight">\(\mu_1(X_i)\)</span>, <span class="math notranslate nohighlight">\(\mu_0(X_i)\)</span> and <span class="math notranslate nohighlight">\(\mu_D(Z_i)\)</span></p></li>
<li><p>During each step we conduct four estimations for the ATE</p></li>
</ul>
</li>
</ul>
</li>
<li><p>We will iterate over this process 10 times whereupon the correlation between <span class="math notranslate nohighlight">\(U_1\)</span> and <span class="math notranslate nohighlight">\(V\)</span>, captured by <span class="math notranslate nohighlight">\(\rho_{1,V}\)</span> increases during each iteration</p></li>
</ul>
<div class="section" id="Create-a-specification-file">
<h3>Create a specification file<a class="headerlink" href="#Create-a-specification-file" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%file</span> files/mc.grmpy.yml
<span class="o">---</span>
<span class="n">SIMULATION</span><span class="p">:</span>
    <span class="n">agents</span><span class="p">:</span> <span class="mi">10000</span>
    <span class="n">seed</span><span class="p">:</span> <span class="mi">2356</span>
    <span class="n">source</span><span class="p">:</span> <span class="n">data</span>
<span class="n">ESTIMATION</span><span class="p">:</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">mc</span><span class="o">.</span><span class="n">grmpy</span><span class="o">.</span><span class="n">pkl</span>
    <span class="n">output_file</span><span class="p">:</span> <span class="n">est</span><span class="o">.</span><span class="n">grmpy</span><span class="o">.</span><span class="n">info</span>
    <span class="n">dependent</span><span class="p">:</span> <span class="n">Y</span>
    <span class="n">indicator</span><span class="p">:</span> <span class="n">D</span>
    <span class="n">print_output</span><span class="p">:</span> <span class="kc">False</span>
    <span class="n">start</span><span class="p">:</span> <span class="n">auto</span>
    <span class="n">maxiter</span><span class="p">:</span> <span class="mi">10000</span>
    <span class="n">optimizer</span><span class="p">:</span> <span class="n">BFGS</span>
<span class="n">TREATED</span><span class="p">:</span>
    <span class="n">params</span><span class="p">:</span>
    <span class="o">-</span> <span class="mf">1.0</span>
    <span class="o">-</span> <span class="mf">0.555</span>
    <span class="o">-</span> <span class="o">-</span><span class="mf">0.555</span>
    <span class="o">-</span> <span class="mf">0.755</span>
    <span class="o">-</span> <span class="mf">0.155</span>
    <span class="n">order</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">const</span>
    <span class="o">-</span> <span class="n">X2</span>
    <span class="o">-</span> <span class="n">X3</span>
    <span class="o">-</span> <span class="n">X4</span>
    <span class="o">-</span> <span class="n">X5</span>
<span class="n">UNTREATED</span><span class="p">:</span>
    <span class="n">params</span><span class="p">:</span>
    <span class="o">-</span> <span class="mf">0.5</span>
    <span class="o">-</span> <span class="mf">0.255</span>
    <span class="o">-</span> <span class="o">-</span><span class="mf">0.255</span>
    <span class="o">-</span> <span class="mf">0.1768</span>
    <span class="o">-</span> <span class="mf">0.0987</span>
    <span class="n">order</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">const</span>
    <span class="o">-</span> <span class="n">X2</span>
    <span class="o">-</span> <span class="n">X3</span>
    <span class="o">-</span> <span class="n">X4</span>
    <span class="o">-</span> <span class="n">X5</span>
<span class="n">CHOICE</span><span class="p">:</span>
    <span class="n">params</span><span class="p">:</span>
    <span class="o">-</span> <span class="mf">0.28</span>
    <span class="o">-</span> <span class="o">-</span><span class="mf">0.39</span>
    <span class="o">-</span> <span class="mf">0.59</span>
    <span class="o">-</span> <span class="o">-</span><span class="mf">0.89</span>
    <span class="o">-</span> <span class="o">-</span><span class="mf">0.73</span>
    <span class="n">order</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">const</span>
    <span class="o">-</span> <span class="n">X6</span>
    <span class="o">-</span> <span class="n">X7</span>
    <span class="o">-</span> <span class="n">X8</span>
    <span class="o">-</span> <span class="n">X9</span>
<span class="n">DIST</span><span class="p">:</span>
    <span class="n">params</span><span class="p">:</span>
    <span class="o">-</span> <span class="mf">0.5</span>
    <span class="o">-</span> <span class="mf">0.0</span>
    <span class="o">-</span> <span class="mf">0.0</span>
    <span class="o">-</span> <span class="mf">0.5</span>
    <span class="o">-</span> <span class="mf">0.0</span>
    <span class="o">-</span> <span class="mf">1.0</span>
<span class="n">VARTYPES</span><span class="p">:</span>
    <span class="n">const</span><span class="p">:</span> <span class="n">nonbinary</span>
    <span class="n">X2</span><span class="p">:</span> <span class="n">nonbinary</span>
    <span class="n">X3</span><span class="p">:</span> <span class="n">nonbinary</span>
    <span class="n">X4</span><span class="p">:</span> <span class="n">nonbinary</span>
    <span class="n">X5</span><span class="p">:</span> <span class="n">nonbinary</span>
    <span class="n">X6</span><span class="p">:</span> <span class="n">nonbinary</span>
    <span class="n">X7</span><span class="p">:</span> <span class="n">nonbinary</span>
    <span class="n">X8</span><span class="p">:</span> <span class="n">nonbinary</span>
    <span class="n">X9</span><span class="p">:</span> <span class="n">nonbinary</span>
<span class="n">SCIPY</span><span class="o">-</span><span class="n">BFGS</span><span class="p">:</span>
    <span class="n">gtol</span><span class="p">:</span> <span class="mf">1.0e-05</span>
    <span class="n">eps</span><span class="p">:</span> <span class="mf">1.4901161193847655e-08</span>
<span class="n">SCIPY</span><span class="o">-</span><span class="n">POWELL</span><span class="p">:</span>
    <span class="n">xtol</span><span class="p">:</span> <span class="mf">0.0001</span>
    <span class="n">ftol</span><span class="p">:</span> <span class="mf">0.00001</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Overwriting files/mc.grmpy.yml
</pre></div></div>
</div>
</div>
<div class="section" id="Define-some-auxiliary-functions">
<h3>Define some auxiliary functions<a class="headerlink" href="#Define-some-auxiliary-functions" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">update_correlation_structure</span><span class="p">(</span><span class="n">model_dict</span><span class="p">,</span> <span class="n">rho</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function takes a valid model specification and updates the correlation</span>
<span class="sd">    structure among the unobservables.&quot;&quot;&quot;</span>

    <span class="c1"># We first extract the baseline information from the model dictionary.</span>
    <span class="n">sd_v</span> <span class="o">=</span> <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;DIST&quot;</span><span class="p">][</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sd_u1</span> <span class="o">=</span> <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;DIST&quot;</span><span class="p">][</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Now we construct the implied covariance, which is relevant for the initialization</span>
    <span class="c1"># file.</span>
    <span class="n">cov1v</span> <span class="o">=</span> <span class="o">-</span><span class="n">rho</span> <span class="o">*</span> <span class="n">sd_v</span> <span class="o">*</span> <span class="n">sd_u1</span>

    <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;DIST&quot;</span><span class="p">][</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov1v</span>
    <span class="c1"># We print out the specification to an initialization file with the name</span>
    <span class="c1"># mc_init.grmpy.ini.</span>
    <span class="n">print_dict</span><span class="p">(</span><span class="n">model_dict</span><span class="p">,</span> <span class="s2">&quot;files/mc&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_data</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function creates the a data set based for the monte carlo simulation</span>
<span class="sd">    setup.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read in initialization file and the data set</span>
    <span class="n">init_dict</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s2">&quot;mc.grmpy.pkl&quot;</span><span class="p">)</span>

    <span class="c1"># Distribute information</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">init_dict</span><span class="p">[</span><span class="s2">&quot;TREATED&quot;</span><span class="p">][</span><span class="s2">&quot;order&quot;</span><span class="p">]]</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">init_dict</span><span class="p">[</span><span class="s2">&quot;CHOICE&quot;</span><span class="p">][</span><span class="s2">&quot;order&quot;</span><span class="p">]]</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">init_dict</span><span class="p">[</span><span class="s2">&quot;SIMULATION&quot;</span><span class="p">][</span><span class="s2">&quot;seed&quot;</span><span class="p">]</span>

    <span class="n">beta1</span> <span class="o">=</span> <span class="n">init_dict</span><span class="p">[</span><span class="s2">&quot;TREATED&quot;</span><span class="p">][</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>
    <span class="n">beta0</span> <span class="o">=</span> <span class="n">init_dict</span><span class="p">[</span><span class="s2">&quot;UNTREATED&quot;</span><span class="p">][</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">init_dict</span><span class="p">[</span><span class="s2">&quot;CHOICE&quot;</span><span class="p">][</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>

    <span class="c1"># Set random seed to ensure recomputabiltiy</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="c1"># Simulate unobservables</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">simulate_unobservables</span><span class="p">(</span><span class="n">init_dict</span><span class="p">)</span>

    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;U1&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;U0&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="s2">&quot;U1&quot;</span><span class="p">],</span> <span class="n">U</span><span class="p">[</span><span class="s2">&quot;U0&quot;</span><span class="p">],</span> <span class="n">U</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">]</span>
    <span class="c1"># Simulate choice and output</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Y1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">beta1</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;U1&quot;</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Y0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">beta0</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;U0&quot;</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Y1&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Y0&quot;</span><span class="p">]</span>

    <span class="c1"># Save the data</span>
    <span class="n">data</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s2">&quot;mc.grmpy.pkl&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df_base</span> <span class="o">=</span> <span class="n">grmpy</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="s2">&quot;files/mc.grmpy.yml&quot;</span><span class="p">)</span>
<span class="n">df_base</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s2">&quot;mc.grmpy.pkl&quot;</span><span class="p">)</span>

<span class="c1"># Define a dictionary with a key for each estimation strategy</span>
<span class="n">effects</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">key_</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;grmpy&quot;</span><span class="p">,</span> <span class="s2">&quot;ols&quot;</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="s2">&quot;rho&quot;</span><span class="p">,</span> <span class="s2">&quot;iv&quot;</span><span class="p">,</span> <span class="s2">&quot;means&quot;</span><span class="p">]:</span>
    <span class="n">effects</span><span class="p">[</span><span class="n">key_</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>


<span class="c1"># Loop over different correlations between V and U_1</span>
<span class="k">for</span> <span class="n">rho</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
    <span class="n">effects</span><span class="p">[</span><span class="s2">&quot;rho&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">rho</span><span class="p">]</span>

    <span class="c1"># Readjust the initialization file values to add correlation</span>
    <span class="n">model_spec</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="s2">&quot;files/mc.grmpy.yml&quot;</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">model_spec</span><span class="p">[</span><span class="s2">&quot;TREATED&quot;</span><span class="p">][</span><span class="s2">&quot;order&quot;</span><span class="p">]</span>
    <span class="n">update_correlation_structure</span><span class="p">(</span><span class="n">model_spec</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span>
    <span class="n">sim_spec</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="s2">&quot;files/mc.grmpy.yml&quot;</span><span class="p">)</span>

    <span class="c1"># Simulate a Data set and specify exogeneous and endogeneous variables</span>
    <span class="n">df_mc</span> <span class="o">=</span> <span class="n">create_data</span><span class="p">(</span><span class="s2">&quot;files/mc.grmpy.yml&quot;</span><span class="p">)</span>

    <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">exog_ols</span> <span class="o">=</span> <span class="n">df_mc</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">],</span> <span class="n">df_mc</span><span class="p">[</span><span class="n">X</span><span class="p">],</span> <span class="n">df_mc</span><span class="p">[[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">X</span><span class="p">]</span>

    <span class="n">instr</span> <span class="o">=</span> <span class="n">sim_spec</span><span class="p">[</span><span class="s2">&quot;CHOICE&quot;</span><span class="p">][</span><span class="s2">&quot;order&quot;</span><span class="p">]</span>
    <span class="n">instr</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instr</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="s2">&quot;const&quot;</span><span class="p">]</span>

    <span class="c1"># Estimate  via grmpy (LIV)</span>
    <span class="n">rslt</span> <span class="o">=</span> <span class="n">grmpy</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="s2">&quot;files/mc.grmpy.yml&quot;</span><span class="p">)</span>
    <span class="n">beta_diff</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">rslt</span><span class="p">[</span><span class="s2">&quot;opt_rslt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;TREATED&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">params</span>
        <span class="o">-</span> <span class="n">rslt</span><span class="p">[</span><span class="s2">&quot;opt_rslt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;UNTREATED&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">params</span>
    <span class="p">)</span>
    <span class="n">stat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">exog</span><span class="p">),</span> <span class="n">beta_diff</span><span class="p">)</span>
    <span class="n">effects</span><span class="p">[</span><span class="s2">&quot;grmpy&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">stat</span><span class="p">]</span>

    <span class="c1"># Estimate via OLS</span>
    <span class="n">ols</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">exog_ols</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="n">stat</span> <span class="o">=</span> <span class="n">ols</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">effects</span><span class="p">[</span><span class="s2">&quot;ols&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">stat</span><span class="p">]</span>

    <span class="c1"># Estimate via 2SLS</span>
    <span class="n">iv</span> <span class="o">=</span> <span class="n">IV2SLS</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">df_mc</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">],</span> <span class="n">df_mc</span><span class="p">[</span><span class="n">instr</span><span class="p">])</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="n">stat</span> <span class="o">=</span> <span class="n">iv</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span>
    <span class="n">effects</span><span class="p">[</span><span class="s2">&quot;iv&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">stat</span><span class="p">]</span>

    <span class="c1"># Estimate via naive comparison</span>
    <span class="n">random</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">df_mc</span><span class="p">[</span><span class="n">df_mc</span><span class="o">.</span><span class="n">D</span> <span class="o">==</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;Y&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">df_mc</span><span class="p">[</span><span class="n">df_mc</span><span class="o">.</span><span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">][</span><span class="s2">&quot;Y&quot;</span><span class="p">])</span>
    <span class="n">stat</span> <span class="o">=</span> <span class="n">random</span>
    <span class="n">effects</span><span class="p">[</span><span class="s2">&quot;random&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">stat</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Plot-results">
<h3>Plot results<a class="headerlink" href="#Plot-results" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1"># Plot all graphs in one plot</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.005</span><span class="p">,</span> <span class="mf">1.005</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$B^</span><span class="si">{ATE}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\rho_{U_1, V}$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;xtick&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;ytick&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="c1"># Plot evaluated effects</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True value&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">effects</span><span class="p">[</span><span class="s2">&quot;grmpy&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;LIV&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">grid</span><span class="p">,</span>
    <span class="n">effects</span><span class="p">[</span><span class="s2">&quot;random&quot;</span><span class="p">],</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Naive comparison&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">effects</span><span class="p">[</span><span class="s2">&quot;iv&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;IV&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">grid</span><span class="p">,</span>
    <span class="n">effects</span><span class="p">[</span><span class="s2">&quot;ols&quot;</span><span class="p">],</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;OLS&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f34a90bb850&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/lectures_generalized-roy-model_notebook_40_1.png" src="../../_images/lectures_generalized-roy-model_notebook_40_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../mechanisms-causal-explanation/notebook.html" class="btn btn-neutral float-right" title="Mechanisms and causal explanation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../instrumental-variable/notebook.html" class="btn btn-neutral float-left" title="Instrumental variable estimators of causal effects" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Prof. Dr. Philipp Eisenhauer.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
